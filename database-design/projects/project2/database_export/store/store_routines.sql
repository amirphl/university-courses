CREATE DATABASE  IF NOT EXISTS `store` /*!40100 DEFAULT CHARACTER SET utf8 */;
USE `store`;
-- MySQL dump 10.13  Distrib 5.7.9, for Win64 (x86_64)
--
-- Host: localhost    Database: store
-- ------------------------------------------------------
-- Server version	5.7.11-log

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Temporary view structure for view `transmitteraverageall`
--

DROP TABLE IF EXISTS `transmitteraverageall`;
/*!50001 DROP VIEW IF EXISTS `transmitteraverageall`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `transmitteraverageall` AS SELECT 
 1 AS `id`,
 1 AS `average`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `h2`
--

DROP TABLE IF EXISTS `h2`;
/*!50001 DROP VIEW IF EXISTS `h2`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `h2` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `h3`
--

DROP TABLE IF EXISTS `h3`;
/*!50001 DROP VIEW IF EXISTS `h3`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `h3` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `h1`
--

DROP TABLE IF EXISTS `h1`;
/*!50001 DROP VIEW IF EXISTS `h1`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `h1` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `h4`
--

DROP TABLE IF EXISTS `h4`;
/*!50001 DROP VIEW IF EXISTS `h4`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `h4` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `h5`
--

DROP TABLE IF EXISTS `h5`;
/*!50001 DROP VIEW IF EXISTS `h5`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `h5` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `customersaverage`
--

DROP TABLE IF EXISTS `customersaverage`;
/*!50001 DROP VIEW IF EXISTS `customersaverage`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `customersaverage` AS SELECT 
 1 AS `average`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `m4`
--

DROP TABLE IF EXISTS `m4`;
/*!50001 DROP VIEW IF EXISTS `m4`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `m4` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `m1`
--

DROP TABLE IF EXISTS `m1`;
/*!50001 DROP VIEW IF EXISTS `m1`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `m1` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `m0`
--

DROP TABLE IF EXISTS `m0`;
/*!50001 DROP VIEW IF EXISTS `m0`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `m0` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `m2`
--

DROP TABLE IF EXISTS `m2`;
/*!50001 DROP VIEW IF EXISTS `m2`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `m2` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `m3`
--

DROP TABLE IF EXISTS `m3`;
/*!50001 DROP VIEW IF EXISTS `m3`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `m3` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `temporarycustomersaverage`
--

DROP TABLE IF EXISTS `temporarycustomersaverage`;
/*!50001 DROP VIEW IF EXISTS `temporarycustomersaverage`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `temporarycustomersaverage` AS SELECT 
 1 AS `average`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `rejected2`
--

DROP TABLE IF EXISTS `rejected2`;
/*!50001 DROP VIEW IF EXISTS `rejected2`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `rejected2` AS SELECT 
 1 AS `customerEmail`,
 1 AS `phone_number`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `rejected1`
--

DROP TABLE IF EXISTS `rejected1`;
/*!50001 DROP VIEW IF EXISTS `rejected1`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `rejected1` AS SELECT 
 1 AS `customerUsername`,
 1 AS `phone_number`*/;
SET character_set_client = @saved_cs_client;

--
-- Temporary view structure for view `s`
--

DROP TABLE IF EXISTS `s`;
/*!50001 DROP VIEW IF EXISTS `s`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `s` AS SELECT 
 1 AS `shopId`,
 1 AS `productId`,
 1 AS `total`*/;
SET character_set_client = @saved_cs_client;

--
-- Final view structure for view `transmitteraverageall`
--

/*!50001 DROP VIEW IF EXISTS `transmitteraverageall`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `transmitteraverageall` AS (select `r`.`id` AS `id`,avg(`r`.`pr`) AS `average` from (select `s`.`transmitterId` AS `id`,(`c`.`value` * `p`.`price`) AS `pr` from ((`store`.`shipment` `s` join `store`.`customerorders` `c` on(((`s`.`purchase_time` = `c`.`purchase_time`) and (`s`.`customerUsername` = `c`.`customerUsername`) and (`s`.`shopId` = `c`.`shopId`) and (`s`.`productId` = `c`.`productId`)))) join `store`.`product` `p` on((`c`.`productId` = `p`.`id`))) union all select `s`.`transmitterId` AS `id`,(`c`.`value` * `p`.`price`) AS `pr` from ((`store`.`temporaryshipment` `s` join `store`.`temporarycustomerorders` `c` on(((`s`.`purchase_time` = `c`.`purchase_time`) and (`s`.`customerEmail` = `c`.`customerEmail`) and (`s`.`shopId` = `c`.`shopId`) and (`s`.`productId` = `c`.`productId`)))) join `store`.`product` `p` on((`c`.`productId` = `p`.`id`)))) `r` group by `r`.`id`) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `h2`
--

/*!50001 DROP VIEW IF EXISTS `h2`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `h2` AS (select `m1`.`shopId` AS `shopId`,`m1`.`productId` AS `productId`,`m1`.`total` AS `total` from `m1` where `m1`.`total` >= all (select `u`.`total` from `m1` `u` where (`m1`.`shopId` = `u`.`shopId`))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `h3`
--

/*!50001 DROP VIEW IF EXISTS `h3`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `h3` AS (select `m2`.`shopId` AS `shopId`,`m2`.`productId` AS `productId`,`m2`.`total` AS `total` from `m2` where `m2`.`total` >= all (select `u`.`total` from `m2` `u` where (`m2`.`shopId` = `u`.`shopId`))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `h1`
--

/*!50001 DROP VIEW IF EXISTS `h1`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `h1` AS (select `m0`.`shopId` AS `shopId`,`m0`.`productId` AS `productId`,`m0`.`total` AS `total` from `m0` where `m0`.`total` >= all (select `u`.`total` from `m0` `u` where (`m0`.`shopId` = `u`.`shopId`))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `h4`
--

/*!50001 DROP VIEW IF EXISTS `h4`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `h4` AS (select `m3`.`shopId` AS `shopId`,`m3`.`productId` AS `productId`,`m3`.`total` AS `total` from `m3` where `m3`.`total` >= all (select `u`.`total` from `m3` `u` where (`m3`.`shopId` = `u`.`shopId`))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `h5`
--

/*!50001 DROP VIEW IF EXISTS `h5`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `h5` AS (select `m4`.`shopId` AS `shopId`,`m4`.`productId` AS `productId`,`m4`.`total` AS `total` from `m4` where `m4`.`total` >= all (select `u`.`total` from `m4` `u` where (`m4`.`shopId` = `u`.`shopId`))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `customersaverage`
--

/*!50001 DROP VIEW IF EXISTS `customersaverage`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `customersaverage` AS (select avg((`t`.`value` * `p`.`price`)) AS `average` from (`customerorders` `t` join `product` `p` on(((`t`.`productId` = `p`.`id`) and (`t`.`shopId` = `p`.`shopId`)))) where (`t`.`status` <> 'rejected')) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `m4`
--

/*!50001 DROP VIEW IF EXISTS `m4`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `m4` AS (select `m3`.`shopId` AS `shopId`,`m3`.`productId` AS `productId`,`m3`.`total` AS `total` from `m3` where (not((`m3`.`shopId`,`m3`.`productId`,`m3`.`total`) in (select `h4`.`shopId`,`h4`.`productId`,`h4`.`total` from `h4`)))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `m1`
--

/*!50001 DROP VIEW IF EXISTS `m1`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `m1` AS (select `m0`.`shopId` AS `shopId`,`m0`.`productId` AS `productId`,`m0`.`total` AS `total` from `m0` where (not((`m0`.`shopId`,`m0`.`productId`,`m0`.`total`) in (select `h1`.`shopId`,`h1`.`productId`,`h1`.`total` from `h1`)))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `m0`
--

/*!50001 DROP VIEW IF EXISTS `m0`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `m0` AS (select `s`.`shopId` AS `shopId`,`s`.`productId` AS `productId`,sum(`s`.`total`) AS `total` from `s` group by `s`.`shopId`,`s`.`productId`) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `m2`
--

/*!50001 DROP VIEW IF EXISTS `m2`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `m2` AS (select `m1`.`shopId` AS `shopId`,`m1`.`productId` AS `productId`,`m1`.`total` AS `total` from `m1` where (not((`m1`.`shopId`,`m1`.`productId`,`m1`.`total`) in (select `h2`.`shopId`,`h2`.`productId`,`h2`.`total` from `h2`)))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `m3`
--

/*!50001 DROP VIEW IF EXISTS `m3`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `m3` AS (select `m2`.`shopId` AS `shopId`,`m2`.`productId` AS `productId`,`m2`.`total` AS `total` from `m2` where (not((`m2`.`shopId`,`m2`.`productId`,`m2`.`total`) in (select `h3`.`shopId`,`h3`.`productId`,`h3`.`total` from `h3`)))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `temporarycustomersaverage`
--

/*!50001 DROP VIEW IF EXISTS `temporarycustomersaverage`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `temporarycustomersaverage` AS (select avg((`t`.`value` * `p`.`price`)) AS `average` from (`temporarycustomerorders` `t` join `product` `p` on(((`t`.`productId` = `p`.`id`) and (`t`.`shopId` = `p`.`shopId`)))) where (`t`.`status` <> 'rejected')) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `rejected2`
--

/*!50001 DROP VIEW IF EXISTS `rejected2`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `rejected2` AS (select `c`.`customerEmail` AS `customerEmail`,`t`.`phone_number` AS `phone_number` from (`temporarycustomerorders` `c` join `temporarycustomers` `t` on((`c`.`customerEmail` = `t`.`email`))) where (`c`.`status` = 'rejected')) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `rejected1`
--

/*!50001 DROP VIEW IF EXISTS `rejected1`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `rejected1` AS (select `c`.`customerUsername` AS `customerUsername`,`c`.`phone_number` AS `phone_number` from `customerorders` `c` where (`c`.`status` = 'rejected')) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `s`
--

/*!50001 DROP VIEW IF EXISTS `s`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `s` AS (select `c`.`shopId` AS `shopId`,`c`.`productId` AS `productId`,sum(`c`.`value`) AS `total` from `customerorders` `c` group by `c`.`shopId`,`c`.`productId`) union all (select `t`.`shopId` AS `shopId`,`t`.`productId` AS `productId`,sum(`t`.`value`) AS `sum(T.value)` from `temporarycustomerorders` `t` group by `t`.`shopId`,`t`.`productId`) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Dumping events for database 'store'
--

--
-- Dumping routines for database 'store'
--
/*!50003 DROP PROCEDURE IF EXISTS `add_customer` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `add_customer`(IN us VARCHAR(100), #username
                              IN pa VARCHAR(30), #password
                              IN em VARCHAR(150), #email
                              IN fi VARCHAR(100), #first_name
                              IN la VARCHAR(100), #last_name
                              IN po CHAR(10), #postal_code
                              IN ge ENUM ('man', 'woman'), #gender
                              IN cr INT UNSIGNED # credit
)
BEGIN
    INSERT INTO customers (username, password, email, first_name, last_name, postal_code, gender, credit)
    VALUES (us, sha1(pa), em, fi, la, po, ge, cr);
  END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `add_order_by_customer` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `add_order_by_customer`(IN cu VARCHAR(100), # customerUsername
                                       IN sh INT UNSIGNED, # shopId
                                       IN pr INT UNSIGNED, # productId
                                       IN va INTEGER, # value
                                       IN pa ENUM ('online', 'offline'), # payment_type
                                       IN ad VARCHAR(200), # address
                                       IN ph VARCHAR(14) # phone_number
)
BEGIN

    SELECT @price_of_product := P.price
    FROM product AS P
    WHERE P.shopId = sh AND P.id = pr;

    SELECT @offer_of_product := P.offer
    FROM product AS P
    WHERE P.shopId = sh AND P.id = pr;

    SELECT @supply_of_product := P.value
    FROM product AS P
    WHERE P.shopId = sh AND P.id = pr;

    SELECT @cu_cred := C.credit
    FROM customers AS C
    WHERE C.username = cu;

    SELECT @shop_start_time := S.start_time
    FROM shop AS S
    WHERE S.id = sh;

    SELECT @shop_end_time := S.end_time
    FROM shop AS S
    WHERE S.id = sh;

    IF @supply_of_product < va OR @cu_cred < ((1.0 - @offer_of_product) * @price_of_product * va) OR
       @shop_start_time > current_time OR
       current_time > @shop_end_time
    THEN

      INSERT INTO customerorders (customerUsername, shopId, productId, value, status, payment_type, address, phone_number)
        VALUE (cu, sh, pr, va, 'rejected', pa, ad, ph);

    ELSE

      UPDATE customers AS C
      SET C.credit = C.credit - (1.0 - @offer_of_product) * @price_of_product * va
      WHERE C.username = cu AND pa = 'online';

      UPDATE product AS P
      SET P.value = P.value - va
      WHERE P.id = pr AND P.shopId = sh;

      INSERT INTO customerorders (customerUsername, shopId, productId, value, payment_type, address, phone_number)
        VALUE (cu, sh, pr, va, pa, ad, ph);

    END IF;

  END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `add_order_by_temporary_customer` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `add_order_by_temporary_customer`(IN cu VARCHAR(150), # customerEmail
                                                 IN sh INT UNSIGNED, # shop id
                                                 IN pr INT UNSIGNED, # product id
                                                 IN va INTEGER # value
)
BEGIN
    DECLARE `_rollback` BOOL DEFAULT 0;
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
    START TRANSACTION;

    SELECT @supply_of_product := P.value
    FROM product AS P
    WHERE P.shopId = sh AND P.id = pr;

    SELECT @shop_start_time := S.start_time
    FROM shop AS S
    WHERE S.id = sh;

    SELECT @shop_end_time := S.end_time
    FROM shop AS S
    WHERE S.id = sh;

    IF @shop_start_time <= current_time AND current_time <= @shop_end_time AND @supply_of_product >= va
    THEN

      INSERT INTO temporarycustomerorders (customerEmail, shopId, productId, value)
        VALUE (cu, sh, pr, va);

      UPDATE product AS P
      SET P.value = P.value - va
      WHERE P.id = pr AND P.shopId = sh;

    ELSE
      INSERT INTO temporarycustomerorders (customerEmail, shopId, productId, value, status)
        VALUE (cu, sh, pr, va, 'rejected');
    END IF;

    IF `_rollback`
    THEN
      ROLLBACK;
    ELSE
      COMMIT;
    END IF;
  END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `charge_account` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `charge_account`(IN us VARCHAR(100), #username
                                IN cr INT UNSIGNED #credit
)
BEGIN
    IF cr > 0
    THEN
      UPDATE customers
      SET credit = credit + cr
      WHERE username = us;
    END IF;
  END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `deliver_to_customer` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `deliver_to_customer`(tid INT UNSIGNED, # transmitterID
                                     pt  TIMESTAMP, # purchase_time
                                     cu  VARCHAR(100), # customerUsername
                                     sh  INT UNSIGNED, # shopId
                                     pr  INT UNSIGNED # productId
)
BEGIN
    DECLARE state ENUM ('accepted', 'rejected', 'sending', 'done');

    SELECT status
    INTO state
    FROM customerorders AS C
    WHERE C.purchase_time = pt AND C.customerUsername = cu AND C.shopId = sh AND C.productId = pr;

    IF state != 'done'
    THEN
      UPDATE customerorders AS C
      SET C.status = 'done'
      WHERE C.purchase_time = pt AND C.customerUsername = cu AND C.shopId = sh AND C.productId = pr;

      UPDATE transmitters AS T
      SET T.status = 'free', T.credit = T.credit + 0.05 * (SELECT P.price
                                                           FROM product AS P
                                                           WHERE P.id = pr AND P.shopId = sh)
      WHERE T.id = tid AND T.shopId = sh;
    END IF;
  END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `deliver_to_temporary_customer` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `deliver_to_temporary_customer`(tid INT UNSIGNED, # transmitterID
                                               pt  TIMESTAMP, # purchase_time
                                               ce  VARCHAR(100), # customerEmail
                                               sh  INT UNSIGNED, # shopId
                                               pr  INT UNSIGNED # productId
)
BEGIN
    DECLARE state ENUM ('accepted', 'rejected', 'sending', 'done');

    SELECT status
    INTO state
    FROM temporarycustomerorders AS C
    WHERE C.purchase_time = pt AND C.customerEmail = ce AND C.shopId = sh AND C.productId = pr;

    IF state != 'done'
    THEN
      UPDATE temporarycustomerorders AS C
      SET C.status = 'done'
      WHERE C.purchase_time = pt AND C.customerEmail = ce AND C.shopId = sh AND C.productId = pr;

      UPDATE transmitters AS T
      SET T.status = 'free', T.credit = T.credit + 0.05 * (SELECT P.price
                                                           FROM product AS P
                                                           WHERE P.id = pr AND P.shopId = sh)
      WHERE T.id = tid AND T.shopId = sh;
    END IF;
  END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2019-01-17 20:27:03
